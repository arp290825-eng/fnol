{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/pranaynath/Documents/GitHub/fnol/Autonomous-Claims-Orchestrator/frontend/app/api/decision-pack/pdf/route.ts"],"sourcesContent":["/**\n * POST /api/decision-pack/pdf\n * Generates a structured PDF of the Decision Pack including Claim Status.\n * Uses jsPDF (no external font files) for compatibility with serverless/bundled environments.\n */\nimport { NextRequest, NextResponse } from 'next/server'\nimport { jsPDF } from 'jspdf'\n\ninterface PdfRequestBody {\n  claimData: {\n    claimId?: string\n    decisionPack?: {\n      claimDraft?: Record<string, unknown>\n      evidence?: Array<{ field: string; value: string; confidence: number }>\n      documents?: Array<{ name: string; type?: string }>\n      policyGrounding?: Array<{\n        clauseId: string\n        title: string\n        content?: string\n        snippet?: string\n        score?: number\n        similarity?: number\n        rationale?: string\n      }>\n      evidenceSummary?: { totalFields: number; highConfidenceFields: number }\n    }\n  }\n  claimStatus: 'pending' | 'accepted' | 'rejected'\n}\n\nconst MARGIN = 20\nconst LINE_HEIGHT = 6\nconst PAGE_HEIGHT = 297\n\nfunction addSectionTitle(doc: jsPDF, title: string, y: number): number {\n  doc.setFontSize(12)\n  doc.setFont('helvetica', 'bold')\n  doc.setTextColor(3, 105, 161)\n  doc.text(title, MARGIN, y)\n  doc.setFont('helvetica', 'normal')\n  doc.setFontSize(10)\n  doc.setTextColor(51, 65, 85)\n  return y + LINE_HEIGHT\n}\n\nfunction addKeyValue(doc: jsPDF, key: string, value: unknown, y: number): number {\n  const str = value != null && value !== '' ? String(value) : '—'\n  doc.text(`${key}: ${str}`, MARGIN + 5, y)\n  return y + LINE_HEIGHT\n}\n\nfunction addText(doc: jsPDF, text: string, x: number, y: number, maxWidth: number): number {\n  const lines = doc.splitTextToSize(text, maxWidth)\n  doc.text(lines, x, y)\n  return y + lines.length * LINE_HEIGHT\n}\n\n/** Add text with automatic page breaks when content overflows */\nfunction addTextWithPageBreaks(doc: jsPDF, text: string, x: number, y: number, maxWidth: number): number {\n  const lines = doc.splitTextToSize(text, maxWidth)\n  const bottomMargin = MARGIN + 20\n\n  for (const line of lines) {\n    if (y > PAGE_HEIGHT - bottomMargin) {\n      doc.addPage()\n      y = MARGIN\n    }\n    doc.text(line, x, y)\n    y += LINE_HEIGHT\n  }\n  return y\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = (await request.json()) as PdfRequestBody\n    const { claimData, claimStatus = 'pending' } = body || {}\n\n    if (!claimData?.decisionPack) {\n      return NextResponse.json({ error: 'claimData with decisionPack is required' }, { status: 400 })\n    }\n\n    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' })\n    let y = 20\n\n    const claimId = claimData.claimId || 'N/A'\n    const claimDraft = claimData.decisionPack.claimDraft || {}\n    const evidence = claimData.decisionPack.evidence || []\n    const documents = claimData.decisionPack.documents || []\n    const policyGrounding = claimData.decisionPack.policyGrounding || []\n    const evidenceSummary = claimData.decisionPack.evidenceSummary\n    const maxWidth = 210 - MARGIN * 2\n\n    // Header\n    doc.setFontSize(18)\n    doc.setFont('helvetica', 'bold')\n    doc.setTextColor(30, 41, 59)\n    doc.text('Decision Pack', MARGIN, y)\n    y += 8\n\n    doc.setFontSize(10)\n    doc.setFont('helvetica', 'normal')\n    doc.setTextColor(100, 116, 139)\n    doc.text(`Claim ID: ${claimId}`, MARGIN, y)\n    y += 5\n    doc.text(`Generated: ${new Date().toLocaleString()}`, MARGIN, y)\n    y += 10\n\n    // Claim Status – prominent\n    const statusText = claimStatus === 'accepted' ? 'Accepted' : claimStatus === 'rejected' ? 'Rejected' : 'Pending'\n    doc.setFontSize(14)\n    doc.setFont('helvetica', 'bold')\n    if (claimStatus === 'accepted') doc.setTextColor(4, 120, 87)\n    else if (claimStatus === 'rejected') doc.setTextColor(185, 28, 28)\n    else doc.setTextColor(100, 116, 139)\n    doc.text(`Claim Status: ${statusText}`, MARGIN, y)\n    doc.setTextColor(51, 65, 85)\n    y += 10\n\n    // Claim Summary\n    y = addSectionTitle(doc, 'Claim Summary', y)\n    y = addKeyValue(doc, 'Policy', claimDraft.policyNumber || claimDraft.policyId, y)\n    y = addKeyValue(doc, 'Claimant', claimDraft.claimantName, y)\n    y = addKeyValue(doc, 'Loss Date', claimDraft.lossDate, y)\n    y = addKeyValue(doc, 'Loss Type', claimDraft.lossType, y)\n    y = addKeyValue(doc, 'Location', claimDraft.lossLocation || claimDraft.location || claimDraft.propertyAddress, y)\n    if (claimDraft.deductible != null) y = addKeyValue(doc, 'Deductible', `$${claimDraft.deductible}`, y)\n    y += 5\n\n    // Evidence Summary\n    y = addSectionTitle(doc, 'Evidence Summary', y)\n    y = addKeyValue(doc, 'Documents Attached', documents.length, y)\n    y = addKeyValue(doc, 'Fields Extracted', evidence.length, y)\n    if (evidenceSummary) {\n      y = addKeyValue(doc, 'High Confidence Fields', evidenceSummary.highConfidenceFields, y)\n    }\n    y += 5\n\n    // Policy Grounding\n    if (policyGrounding.length > 0) {\n      y = addSectionTitle(doc, 'Policy Grounding', y)\n      y = addKeyValue(doc, 'Clauses Found', policyGrounding.length, y)\n      y = addKeyValue(doc, 'Coverage', claimDraft.coverageFound ? 'Confirmed' : 'Under Review', y)\n      y += 3\n\n      for (const policy of policyGrounding) {\n        if (y > PAGE_HEIGHT - 50) {\n          doc.addPage()\n          y = MARGIN\n        }\n        doc.setFont('helvetica', 'bold')\n        doc.setFontSize(10)\n        doc.setTextColor(12, 74, 110)\n        y = addText(doc, `${policy.clauseId} – ${policy.title}`, MARGIN + 5, y, maxWidth - 5)\n        doc.setFont('helvetica', 'normal')\n        const score = policy.score ?? policy.similarity ?? 0\n        doc.text(`Match: ${Math.round(score * 100)}%`, MARGIN + 5, y)\n        y += LINE_HEIGHT\n        const content = policy.content || policy.snippet || ''\n        if (content) {\n          doc.setFontSize(9)\n          doc.setTextColor(71, 85, 105)\n          y = addTextWithPageBreaks(doc, content, MARGIN + 10, y, maxWidth - 10)\n          doc.setTextColor(51, 65, 85)\n        }\n        if (policy.rationale) {\n          if (y > PAGE_HEIGHT - 50) {\n            doc.addPage()\n            y = MARGIN\n          }\n          doc.setFontSize(8)\n          doc.setTextColor(148, 163, 184)\n          doc.setFont('helvetica', 'italic')\n          y = addTextWithPageBreaks(doc, `Rationale: ${policy.rationale}`, MARGIN + 10, y, maxWidth - 10)\n          doc.setFont('helvetica', 'normal')\n          doc.setTextColor(51, 65, 85)\n        }\n        y += 5\n      }\n    }\n\n    const buffer = doc.output('arraybuffer')\n    const filename = `Decision-Pack-${claimId.replace(/[/\\\\?%*:|\"<>]/g, '-')}.pdf`\n\n    return new NextResponse(buffer, {\n      status: 200,\n      headers: {\n        'Content-Type': 'application/pdf',\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\n        'Content-Length': String(buffer.byteLength),\n      },\n    })\n  } catch (err) {\n    console.error('PDF generation error:', err)\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : 'Failed to generate PDF' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}