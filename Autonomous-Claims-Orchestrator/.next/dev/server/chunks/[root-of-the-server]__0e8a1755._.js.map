{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/pranaynath/Documents/GitHub/fnol/Autonomous-Claims-Orchestrator/app/api/decision-pack/pdf/route.ts"],"sourcesContent":["/**\n * POST /api/decision-pack/pdf\n * Generates a structured PDF of the Decision Pack including Claim Status\n */\nimport { NextRequest, NextResponse } from 'next/server'\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction getPDFDocumentConstructor(): new (opts?: object) => any {\n  try {\n    const pdfkit = require('pdfkit')\n    const PDF = pdfkit.default ?? pdfkit\n    if (typeof PDF === 'function') return PDF\n  } catch {\n    // fallback\n  }\n  throw new Error('PDFDocument could not be loaded. Ensure pdfkit is installed.')\n}\n\ninterface PdfRequestBody {\n  claimData: {\n    claimId?: string\n    decisionPack?: {\n      claimDraft?: Record<string, unknown>\n      evidence?: Array<{ field: string; value: string; confidence: number }>\n      documents?: Array<{ name: string; type?: string }>\n      policyGrounding?: Array<{\n        clauseId: string\n        title: string\n        content?: string\n        snippet?: string\n        score?: number\n        similarity?: number\n        rationale?: string\n      }>\n      evidenceSummary?: { totalFields: number; highConfidenceFields: number }\n    }\n  }\n  claimStatus: 'pending' | 'accepted' | 'rejected'\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction addSectionTitle(doc: any, title: string, y?: number): void {\n  if (y !== undefined) doc.y = y\n  doc.fontSize(12).font('Helvetica-Bold').fillColor('#0369A1').text(title, { continued: false })\n  doc.moveDown(0.3)\n  doc.font('Helvetica').fontSize(10).fillColor('#334155')\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction addKeyValue(doc: any, key: string, value: unknown): void {\n  const str = value != null && value !== '' ? String(value) : '—'\n  doc.text(`${key}: ${str}`, { indent: 10 })\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = (await request.json()) as PdfRequestBody\n    const { claimData, claimStatus = 'pending' } = body || {}\n\n    if (!claimData?.decisionPack) {\n      return NextResponse.json({ error: 'claimData with decisionPack is required' }, { status: 400 })\n    }\n\n    const PDFDocument = getPDFDocumentConstructor()\n    const doc = new PDFDocument({ margin: 50, size: 'A4' })\n    const chunks: Buffer[] = []\n    doc.on('data', (chunk: Buffer) => chunks.push(chunk))\n\n    const claimId = claimData.claimId || 'N/A'\n    const claimDraft = claimData.decisionPack.claimDraft || {}\n    const evidence = claimData.decisionPack.evidence || []\n    const documents = claimData.decisionPack.documents || []\n    const policyGrounding = claimData.decisionPack.policyGrounding || []\n    const evidenceSummary = claimData.decisionPack.evidenceSummary\n\n    // Header\n    doc.fontSize(18).font('Helvetica-Bold').fillColor('#1E293B').text('Decision Pack', 50, 50)\n    doc.fontSize(10).font('Helvetica').fillColor('#64748B').text(`Claim ID: ${claimId}`, 50, 72)\n    doc.text(`Generated: ${new Date().toLocaleString()}`, 50, 84)\n    doc.moveDown(1)\n\n    // Claim Status – prominent\n    const statusText = claimStatus === 'accepted' ? 'Accepted' : claimStatus === 'rejected' ? 'Rejected' : 'Pending'\n    doc.fontSize(14).font('Helvetica-Bold')\n    if (claimStatus === 'accepted') doc.fillColor('#047857')\n    else if (claimStatus === 'rejected') doc.fillColor('#B91C1C')\n    else doc.fillColor('#64748B')\n    doc.text(`Claim Status: ${statusText}`, 50, doc.y + 10)\n    doc.moveDown(0.8)\n    doc.font('Helvetica').fontSize(10).fillColor('#334155')\n\n    // Claim Summary\n    addSectionTitle(doc, 'Claim Summary')\n    addKeyValue(doc, 'Policy', claimDraft.policyNumber || claimDraft.policyId)\n    addKeyValue(doc, 'Claimant', claimDraft.claimantName)\n    addKeyValue(doc, 'Loss Date', claimDraft.lossDate)\n    addKeyValue(doc, 'Loss Type', claimDraft.lossType)\n    addKeyValue(doc, 'Location', claimDraft.lossLocation || claimDraft.location || claimDraft.propertyAddress)\n    if (claimDraft.deductible != null) addKeyValue(doc, 'Deductible', `$${claimDraft.deductible}`)\n    doc.moveDown(0.5)\n\n    // Evidence Summary\n    addSectionTitle(doc, 'Evidence Summary')\n    addKeyValue(doc, 'Documents Attached', documents.length)\n    addKeyValue(doc, 'Fields Extracted', evidence.length)\n    if (evidenceSummary) {\n      addKeyValue(doc, 'High Confidence Fields', evidenceSummary.highConfidenceFields)\n    }\n    doc.moveDown(0.5)\n\n    // Policy Grounding\n    if (policyGrounding.length > 0) {\n      addSectionTitle(doc, 'Policy Grounding')\n      addKeyValue(doc, 'Clauses Found', policyGrounding.length)\n      addKeyValue(doc, 'Coverage', claimDraft.coverageFound ? 'Confirmed' : 'Under Review')\n      doc.moveDown(0.3)\n\n      policyGrounding.forEach((policy, i) => {\n        if (doc.y > 700) {\n          doc.addPage()\n          doc.y = 50\n        }\n        doc.font('Helvetica-Bold').fontSize(10).fillColor('#0C4A6E')\n        doc.text(`${policy.clauseId} – ${policy.title}`, { indent: 10 })\n        const score = policy.score ?? policy.similarity ?? 0\n        doc.font('Helvetica').text(`Match: ${Math.round(score * 100)}%`, { indent: 10 })\n        const content = policy.content || policy.snippet || ''\n        if (content) {\n          doc.fontSize(9).fillColor('#475569')\n          doc.text(content.slice(0, 300) + (content.length > 300 ? '...' : ''), { indent: 15, align: 'left' })\n        }\n        if (policy.rationale) {\n          doc.fontSize(8).fillColor('#94A3B8').font('Helvetica-Oblique')\n          doc.text(`Rationale: ${policy.rationale}`, { indent: 15 })\n          doc.font('Helvetica')\n        }\n        doc.moveDown(0.4)\n      })\n    }\n\n    doc.end()\n\n    const buffer = await new Promise<Buffer>((resolve, reject) => {\n      doc.on('end', () => resolve(Buffer.concat(chunks)))\n      doc.on('error', reject)\n    })\n\n    const filename = `Decision-Pack-${claimId.replace(/[/\\\\?%*:|\"<>]/g, '-')}.pdf`\n\n    return new NextResponse(new Uint8Array(buffer), {\n      status: 200,\n      headers: {\n        'Content-Type': 'application/pdf',\n        'Content-Disposition': `attachment; filename=\"${filename}\"`,\n        'Content-Length': String(buffer.length),\n      },\n    })\n  } catch (err) {\n    console.error('PDF generation error:', err)\n    return NextResponse.json(\n      { error: err instanceof Error ? err.message : 'Failed to generate PDF' },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}